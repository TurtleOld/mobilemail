# Обработка ошибок

Руководство по обработке ошибок в MobileMail.

## Типы ошибок

### NetworkError

Ошибки сети и подключения.

**Обработка:**

```kotlin
catch (e: IOException) {
    val error = AppError.NetworkError(
        errorMessage = "Ошибка подключения",
        errorCause = e,
        isConnectionError = true
    )
    showError(error)
}
```

### OAuthException

Ошибки OAuth авторизации.

**Обработка:**

```kotlin
catch (e: OAuthException) {
    when (e.statusCode) {
        400 -> // Неверный запрос
        401 -> // Неавторизован
        403 -> // Доступ запрещён
        else -> // Другая ошибка
    }
}
```

### OAuthTokenExpiredException

Токен истёк и не может быть обновлён.

**Обработка:**

```kotlin
catch (e: OAuthTokenExpiredException) {
    // Очистить токены и начать авторизацию заново
    tokenStore.clearTokens(server, email)
    startOAuthFlow()
}
```

## Обработка ошибок Device Flow

### AuthorizationPending

Пользователь ещё не авторизовал устройство.

**Действие:** Продолжить polling, показать инструкции.

### SlowDown

Слишком частые запросы.

**Действие:** Увеличить интервал polling.

### ExpiredToken

Device code истёк.

**Действие:** Остановить polling, предложить начать заново.

### AccessDenied

Пользователь отклонил авторизацию.

**Действие:** Остановить polling, показать сообщение.

## Обработка ошибок JMAP

### 401 Unauthorized

Токен истёк или неверен.

**Обработка:**

```kotlin
if (response.code == 401) {
    try {
        // Попытаться обновить токен
        val newToken = getAccessToken()
        // Повторить запрос
    } catch (e: OAuthTokenExpiredException) {
        // Начать авторизацию заново
    }
}
```

### 403 Forbidden

Доступ запрещён.

**Обработка:** Показать сообщение пользователю.

### 500 Server Error

Ошибка сервера.

**Обработка:** Повторить запрос с экспоненциальной задержкой.

## Лучшие практики

1. **Всегда обрабатывайте ошибки** — не оставляйте необработанные исключения
2. **Показывайте понятные сообщения** — пользователь должен понимать, что произошло
3. **Предлагайте решения** — если возможно, предложите способ исправить ошибку
4. **Логируйте ошибки** — для отладки, но без чувствительных данных
5. **Retry с ограничениями** — повторяйте запросы, но не бесконечно
